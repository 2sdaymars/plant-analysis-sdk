name: Build Raspberry Pi Image
on:
  push:
    tags:
      - 'img-v*'  # img-v1.0.0 íƒœê·¸ë¡œ ì´ë¯¸ì§€ ë¹Œë“œ íŠ¸ë¦¬ê±°
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  build-image:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-user-static \
            kpartx \
            unzip \
            wget \
            parted

      - name: Download base Raspberry Pi OS
        run: |
          echo "ğŸ”½ Downloading Raspberry Pi OS Lite..."
          wget -O raspios-lite.zip \
            "https://downloads.raspberrypi.org/raspios_lite_armhf/images/raspios_lite_armhf-2024-03-15/2024-03-15-raspios-lite.zip"
          unzip raspios-lite.zip
          mv *.img base-raspios.img

      - name: Extend image size
        run: |
          echo "ğŸ“ Extending image size for our software..."
          dd if=/dev/zero bs=1M count=2048 >> base-raspios.img
          echo ", +" | sudo sfdisk -N 2 base-raspios.img
          
      - name: Mount image
        run: |
          echo "ğŸ’¿ Mounting image..."
          sudo losetup -fP base-raspios.img
          export LOOP_DEVICE=$(losetup -a | grep base-raspios.img | cut -d: -f1)
          echo "LOOP_DEVICE=$LOOP_DEVICE" >> $GITHUB_ENV
          
          # íŒŒí‹°ì…˜ í™•ì¥
          sudo e2fsck -f ${LOOP_DEVICE}p2
          sudo resize2fs ${LOOP_DEVICE}p2
          
          # ë§ˆìš´íŠ¸
          sudo mkdir -p /mnt/rpi-boot /mnt/rpi-root
          sudo mount ${LOOP_DEVICE}p1 /mnt/rpi-boot
          sudo mount ${LOOP_DEVICE}p2 /mnt/rpi-root

      - name: Set up chroot environment
        run: |
          echo "ğŸ”§ Setting up chroot environment..."
          sudo cp /usr/bin/qemu-arm-static /mnt/rpi-root/usr/bin/
          
          # DNS ì„¤ì •
          sudo cp /etc/resolv.conf /mnt/rpi-root/etc/resolv.conf
          
          # í•„ìš”í•œ ë””ë ‰í† ë¦¬ ë°”ì¸ë“œ ë§ˆìš´íŠ¸
          sudo mount --bind /dev /mnt/rpi-root/dev
          sudo mount --bind /proc /mnt/rpi-root/proc
          sudo mount --bind /sys /mnt/rpi-root/sys

      - name: Install Plant Analysis SDK
        run: |
          echo "ğŸŒ± Installing Plant Analysis SDK in chroot..."
          
          # ì†ŒìŠ¤ ë³µì‚¬
          sudo cp -r . /mnt/rpi-root/tmp/plant-analysis-sdk/
          
          # chrootì—ì„œ ì„¤ì¹˜ ì‹¤í–‰
          sudo chroot /mnt/rpi-root /bin/bash << 'EOF'
          set -e
          cd /tmp/plant-analysis-sdk
          
          # ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸
          apt-get update
          apt-get upgrade -y
          
          # Plant Analysis SDK ì„¤ì¹˜
          chmod +x enhanced_install.sh
          ./enhanced_install.sh --image-mode --non-interactive
          
          # ë¶€íŒ…ì‹œ ìë™ ì‹œì‘ ì„¤ì •
          systemctl enable plant-monitoring
          
          # SSH í™œì„±í™”
          systemctl enable ssh
          
          # ê¸°ë³¸ ì‚¬ìš©ì ìƒì„± (pi:raspberry)
          echo 'pi:$6$salt$3MJgoM/p2yV5VG5cW4W8XkfJ5JoV/h9F1w2xQWz8xCF2Zn3J' | chpasswd -e
          usermod -aG sudo pi
          
          # ë„¤íŠ¸ì›Œí¬ ì„¤ì •
          cat > /etc/wpa_supplicant/wpa_supplicant.conf << 'WPACONF'
country=US
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1

# ì‚¬ìš©ìê°€ ë‚˜ì¤‘ì— WiFi ì„¤ì •ì„ ì¶”ê°€í•  ìˆ˜ ìˆë„ë¡ ì˜ˆì œ ì œê³µ
# network={
#     ssid="YourWiFiName"
#     psk="YourWiFiPassword"
# }
WPACONF
          
          # ë¶€íŒ… ì„¤ì •
          echo 'dtparam=i2c_arm=on' >> /boot/config.txt
          echo 'camera_auto_detect=1' >> /boot/config.txt
          
          # í™˜ì˜ ë©”ì‹œì§€ ì„¤ì •
          cat > /etc/motd << 'MOTD'
ğŸŒ± Plant Analysis SDK v1.0.0
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Welcome to your Plant Monitoring System!

Quick Start:
â€¢ Web Interface: http://$(hostname -I | cut -d' ' -f1):5000
â€¢ Jupyter Notebook: http://$(hostname -I | cut -d' ' -f1):8888
â€¢ SSH Access: ssh pi@$(hostname -I | cut -d' ' -f1)

Commands:
â€¢ plant-sdk       - Start monitoring
â€¢ plant-web       - Start web interface  
â€¢ plant-jupyter   - Start Jupyter
â€¢ plant-status    - Check system status

Documentation: https://github.com/2sdaymars/plant-analysis-sdk
MOTD

          # ì •ë¦¬
          apt-get autoremove -y
          apt-get autoclean
          rm -rf /tmp/plant-analysis-sdk
          
          echo "âœ… Plant Analysis SDK installation completed!"
EOF

      - name: Clean up and unmount
        run: |
          echo "ğŸ§¹ Cleaning up..."
          sudo umount /mnt/rpi-root/dev /mnt/rpi-root/proc /mnt/rpi-root/sys
          sudo umount /mnt/rpi-root /mnt/rpi-boot
          sudo losetup -d $LOOP_DEVICE

      - name: Create final image
        run: |
          echo "ğŸ“¦ Creating final image..."
          mv base-raspios.img plant-analysis-sdk-$(date +%Y%m%d).img
          
          # ì´ë¯¸ì§€ ì••ì¶•
          zip plant-analysis-sdk-complete-image.zip plant-analysis-sdk-*.img
          
          # ì²´í¬ì„¬ ìƒì„±
          sha256sum plant-analysis-sdk-*.img > plant-analysis-sdk-image.sha256

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            plant-analysis-sdk-complete-image.zip
            plant-analysis-sdk-image.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create release notes
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          body: |
            # ğŸŒ± Plant Analysis SDK - Complete Image Release
            
            ## ğŸ“¥ Download Options
            
            **Complete Image (Recommended for beginners):**
            - Download: `plant-analysis-sdk-complete-image.zip`
            - Flash to SD card using Raspberry Pi Imager
            - Boot and access web interface at `http://raspberrypi.local:5000`
            
            **SDK Package (For developers):**
            - Download source code and run `./enhanced_install.sh`
            
            ## ğŸš€ What's included in the image:
            - âœ… Plant Analysis SDK pre-installed
            - âœ… Web interface ready at port 5000
            - âœ… Jupyter notebook at port 8888
            - âœ… All dependencies installed
            - âœ… SSH enabled (pi:raspberry)
            - âœ… WiFi ready (edit /boot/wpa_supplicant.conf)
            
            ## ğŸ“‹ Default Credentials:
            - Username: `pi`
            - Password: `raspberry`
            - SSH: Enabled
            
            ## ğŸ”§ First Boot:
            1. Flash image to SD card (8GB+ recommended)
            2. Insert SD card to Raspberry Pi
            3. Connect to network
            4. Access http://raspberrypi.local:5000
            
            This provides the exact CinePI experience - download, flash, boot, use!
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}