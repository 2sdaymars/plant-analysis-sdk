name: Build Plant Analysis SDK Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Create release package
      run: |
        # ë¦´ë¦¬ì¦ˆ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p plant-analysis-sdk-release
        
        # í•µì‹¬ íŒŒì¼ë“¤ ë³µì‚¬
        cp plant_monitoring_system.py plant-analysis-sdk-release/
        cp automated_monitoring.py plant-analysis-sdk-release/
        cp one_click_install.sh plant-analysis-sdk-release/
        cp updated_setup.sh plant-analysis-sdk-release/
        cp README.md plant-analysis-sdk-release/
        
        # ì„¤ì¹˜ ê°€ì´ë“œ ìƒì„±
        cat > plant-analysis-sdk-release/INSTALLATION.md << 'EOF'
        # ğŸŒ± Plant Analysis SDK ì„¤ì¹˜ ê°€ì´ë“œ
        
        ## ğŸš€ ë¹ ë¥¸ ì„¤ì¹˜ (ë¼ì¦ˆë² ë¦¬íŒŒì´)
        
        ```bash
        # 1. ì €ì¥ì†Œ ë‹¤ìš´ë¡œë“œ
        git clone https://github.com/2sdaymars/plant-analysis-sdk.git
        cd plant-analysis-sdk
        
        # 2. ì›í´ë¦­ ì„¤ì¹˜ ì‹¤í–‰
        chmod +x one_click_install.sh
        ./one_click_install.sh
        
        # 3. ì‹œìŠ¤í…œ ì‹œì‘
        cd plant_monitoring
        python3 plant_monitoring_system.py
        ```
        
        ## ğŸ“‹ ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­
        - Raspberry Pi 4 (ê¶Œì¥)
        - Raspberry Pi OS (Bookworm)
        - Python 3.9+
        - 8GB+ SD ì¹´ë“œ
        - Pi Camera Module
        
        ## ğŸ”§ ìˆ˜ë™ ì„¤ì¹˜
        ìì„¸í•œ ë‚´ìš©ì€ README.mdë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.
        EOF
        
        # Docker ì„¤ì • íŒŒì¼ ìƒì„±
        cat > plant-analysis-sdk-release/Dockerfile << 'EOF'
        FROM python:3.9-slim
        
        WORKDIR /app
        
        # ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
        RUN apt-get update && apt-get install -y \
            libopencv-dev \
            python3-opencv \
            libatlas-base-dev \
            libjpeg-dev \
            build-essential \
            cmake \
            git \
            && rm -rf /var/lib/apt/lists/*
        
        # Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
        RUN pip install numpy scipy matplotlib pandas opencv-python plantcv scikit-learn jupyter schedule
        
        # ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
        COPY plant_monitoring_system.py .
        COPY automated_monitoring.py .
        
        # ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„±
        RUN mkdir -p /app/plant_monitoring
        
        EXPOSE 8888
        
        CMD ["python3", "plant_monitoring_system.py"]
        EOF
        
        # Docker Compose íŒŒì¼ ìƒì„±
        cat > plant-analysis-sdk-release/docker-compose.yml << 'EOF'
        version: '3.8'
        services:
          plant-analysis:
            build: .
            ports:
              - "8888:8888"
            volumes:
              - ./data:/app/data
              - ./logs:/app/logs
            environment:
              - PYTHONPATH=/app
            restart: unless-stopped
        EOF
        
        # ì••ì¶• íŒŒì¼ ìƒì„±
        tar -czf plant-analysis-sdk-release.tar.gz plant-analysis-sdk-release/
        
        # ì²´í¬ì„¬ ìƒì„±
        sha256sum plant-analysis-sdk-release.tar.gz > plant-analysis-sdk-release.tar.gz.sha256
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: plant-analysis-sdk-release
        path: |
          plant-analysis-sdk-release.tar.gz
          plant-analysis-sdk-release.tar.gz.sha256
          
    - name: Create Release
      id: create_release
      if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name || 'v1.0.0' }}
        release_name: Plant Analysis SDK ${{ github.ref_name || 'v1.0.0' }}
        body: |
          ğŸŒ± Plant Analysis SDK Release
          
          ## ğŸ“¦ í¬í•¨ëœ ë‚´ìš©
          - ì‹ë¬¼ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ
          - ìë™í™” ë„êµ¬
          - ì›í´ë¦­ ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸
          - Docker ì„¤ì • íŒŒì¼
          - ì™„ì „í•œ ì„¤ì¹˜ ê°€ì´ë“œ
          
          ## ğŸš€ ë¹ ë¥¸ ì‹œì‘
          1. `plant-analysis-sdk-release.tar.gz` ë‹¤ìš´ë¡œë“œ
          2. ë¼ì¦ˆë² ë¦¬íŒŒì´ì— ì••ì¶• í•´ì œ
          3. `./one_click_install.sh` ì‹¤í–‰
          
          ## ğŸ“‹ ì‹œìŠ¤í…œ ìš”êµ¬ì‚¬í•­
          - Raspberry Pi 4 (ê¶Œì¥)
          - Raspberry Pi OS Bookworm
          - Python 3.9+
        draft: false
        prerelease: false
        
    - name: Upload Release Asset
      if: steps.create_release.outputs.upload_url
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: plant-analysis-sdk-release.tar.gz
        asset_name: plant-analysis-sdk-release.tar.gz
        asset_content_type: application/gzip
        
    - name: Upload Checksum
      if: steps.create_release.outputs.upload_url
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: plant-analysis-sdk-release.tar.gz.sha256
        asset_name: plant-analysis-sdk-release.tar.gz.sha256
        asset_content_type: text/plain